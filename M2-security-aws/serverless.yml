# serverless.yml
service: can2025-secure-gates

frameworkVersion: '3'
useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-west-1
  stage: ${opt:stage, 'dev'}
  logRetentionInDays: 30
  tracing:
    lambda: true
    apiGateway: true
  apiGateway:
    usagePlan:
      quota:
        limit: 5000
        offset: 2
        period: MONTH
      throttle:
        burstLimit: 200
        rateLimit: 100

  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:Scan
      Resource:
        - !GetAtt UsedJtiTable.Arn
        - !GetAtt AuditTable.Arn
        - !GetAtt SoldTicketsTable.Arn
        - !GetAtt UsersTable.Arn
    # KMS Permissions for encryption/decryption
    - Effect: Allow
      Action:
        - kms:Decrypt
        - kms:DescribeKey
        - kms:Encrypt
        - kms:GenerateDataKey
      Resource:
        - arn:aws:kms:${self:provider.region}:*:key/*
        - arn:aws:kms:${self:provider.region}:*:alias/can2025-*
    # SSM Parameter Store Permissions
    - Effect: Allow
      Action:
        - ssm:GetParameter
        - ssm:GetParameters
        - ssm:GetParametersByPath
      Resource:
        - arn:aws:ssm:${self:provider.region}:*:parameter/can2025/*
    - Effect: Allow
      Action:
        - sqs:SendMessage
      Resource: !GetAtt SecurityQueue.Arn
  
  environment:
    IS_OFFLINE: ${env:IS_OFFLINE, 'false'}
    USED_JTI_TABLE: ${self:service}-used-jti-${opt:stage, self:provider.stage}
    AUDIT_TABLE: ${self:service}-audit-${opt:stage, self:provider.stage}
    SECURITY_QUEUE_URL:
      Ref: SecurityQueue
    SOLD_TICKETS_TABLE: ${self:service}-sold-tickets-${opt:stage, self:provider.stage}
    USERS_TABLE: ${self:service}-users-${opt:stage, self:provider.stage}
    # JWT secret from SSM Parameter Store (KMS encrypted)
    JWT_SECRET_PARAM: /can2025/${opt:stage, self:provider.stage}/jwt-secret
    # Fallback for offline/local development
    JWT_SECRET: ${env:JWT_SECRET, 'can2025-secret-key-local'}

functions:
  verifyTicket:
    handler: src/handlers/verifyTicket.handler
    description: VÃ©rification et validation des billets JWT
    timeout: 10
    memorySize: 256
    events:
      - http:
          path: /security/verifyTicket
          method: post
          cors: true
  
  reportGate:
    handler: src/handlers/reportGate.handler
    description: Rapport de statut des portiques
    timeout: 10
    memorySize: 128
    events:
      - http:
          path: /security/reportGate
          method: post
          cors: true

  login:
    handler: src/handlers/auth.login
    events:
      - http:
          path: auth/login
          method: post
          cors: true

  logout:
    handler: src/handlers/auth.logout
    events:
      - http:
          path: auth/logout
          method: post
          cors: true

  logAnalyzer:
    handler: src/handlers/logAnalyzer.handler
    events:
      - stream:
          type: dynamodb
          arn:
            Fn::GetAtt: [AuditTable, StreamArn]

  rotateKey:
    handler: src/handlers/rotateKey.handler
    timeout: 60
    environment:
      SSM_PARAMETER_PATH: /can2025/${opt:stage, self:provider.stage}/jwt-secret
    # In production, triggered by EventBridge (monthly cron)
    # events:
    #   - schedule: cron(0 0 1 * ? *)  # 1st of every month at midnight

  getSecurityMetrics:
    handler: src/handlers/getSecurityMetrics.handler
    events:
      - http:
          path: security/metrics
          method: get
          cors: true

  sentinelShipper:
    handler: src/handlers/sentinelShipper.handler
    description: Forwards CloudWatch Logs to Azure Sentinel
    memorySize: 128
    timeout: 10
    environment:
      SENTINEL_WORKSPACE_ID: ${env:SENTINEL_WORKSPACE_ID, ''}
      SENTINEL_SHARED_KEY: ${env:SENTINEL_SHARED_KEY, ''}
    events:
      - cloudwatchLog:
          logGroup: /aws/lambda/can2025-secure-gates-dev-verifyTicket
      - cloudwatchLog:
          logGroup: /aws/lambda/can2025-secure-gates-dev-login
      - cloudwatchLog:
          logGroup: /aws/lambda/can2025-secure-gates-dev-reportGate


plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    noPrependStageInUrl: false
    printOutput: true

resources:
  Resources:
    UsedJtiTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USED_JTI_TABLE}
        AttributeDefinitions:
          - AttributeName: jti
            AttributeType: S
        KeySchema:
          - AttributeName: jti
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    AuditTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.AUDIT_TABLE}
        AttributeDefinitions:
          - AttributeName: auditId
            AttributeType: S
        KeySchema:
          - AttributeName: auditId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        StreamSpecification:
          StreamViewType: NEW_IMAGE

    SecurityQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-security-alerts

    SoldTicketsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SOLD_TICKETS_TABLE}
        AttributeDefinitions:
          - AttributeName: ticketId
            AttributeType: S
        KeySchema:
          - AttributeName: ticketId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    SecurityTestInstance:
      Type: AWS::EC2::Instance
      Properties:
        InstanceType: t3.micro
        ImageId: ami-0694d931cee176e7d # Ubuntu 22.04 LTS (eu-west-1)
        # KeyName: my-key-pair # UNCOMMENT and replace with your AWS KeyPair name to enable SSH
        SecurityGroups:
          - !Ref SecurityInstanceSG
        Tags:
          - Key: Name
            Value: ${self:service}-${self:provider.stage}-test-instance

    SecurityInstanceSG:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Allow SSH access to security test instance
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp: 0.0.0.0/0 # WARNING: In production, restrict to your IP only
# serverless.yml
service: can2025-secure-gates

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: eu-west-1
  stage: ${opt:stage, 'dev'}
  logRetentionInDays: 30
  tracing:
    lambda: true
    apiGateway:
      usagePlan:
        quota:
          limit: 5000
          offset: 2
          period: MONTH
        throttle:
          burstLimit: 200
          rateLimit: 100

  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
      Resource:
        - !GetAtt UsedJtiTable.Arn
        - !GetAtt AuditTable.Arn
        - !GetAtt SoldTicketsTable.Arn
        - !GetAtt UsersTable.Arn
    - Effect: Allow
      Action:
        - kms:Decrypt
        - ssm:GetParameter
      Resource: '*'
    - Effect: Allow
      Action:
        - sqs:SendMessage
      Resource: !GetAtt SecurityQueue.Arn
  
  environment:
    IS_OFFLINE: ${env:IS_OFFLINE, 'false'}
    USED_JTI_TABLE: ${self:service}-used-jti-${opt:stage, self:provider.stage}
    AUDIT_TABLE: ${self:service}-audit-${opt:stage, self:provider.stage}
    SECURITY_QUEUE_URL:
      Ref: SecurityQueue
    SOLD_TICKETS_TABLE: ${self:service}-sold-tickets-${opt:stage, self:provider.stage}
    USERS_TABLE: ${self:service}-users-${opt:stage, self:provider.stage}
    JWT_SECRET: ${ssm:/can2025/${opt:stage, self:provider.stage}/jwt-secret~true, 'can2025-secret-key-local'}

functions:
  verifyTicket:
    handler: src/handlers/verifyTicket.handler
    description: VÃ©rification et validation des billets JWT
    timeout: 10
    memorySize: 256
    events:
      - http:
          path: /security/verifyTicket
          method: post
          cors: true
  
  reportGate:
    handler: src/handlers/reportGate.handler
    description: Rapport de statut des portiques
    timeout: 10
    memorySize: 128
    events:
      - http:
          path: /security/reportGate
          method: post
          cors: true

  login:
    handler: src/handlers/auth.login
    events:
      - http:
          path: auth/login
          method: post
          cors: true

  logout:
    handler: src/handlers/auth.logout
    events:
      - http:
          path: auth/logout
          method: post
          cors: true

  logAnalyzer:
    handler: src/handlers/logAnalyzer.handler
    events:
      - stream:
          type: dynamodb
          arn:
            Fn::GetAtt: [AuditTable, StreamArn]

  rotateKey:
    handler: src/handlers/rotateKey.handler
    timeout: 60
    environment:
      SSM_PARAMETER_PATH: /can2025/${opt:stage, self:provider.stage}/jwt-secret
    # In production, triggered by EventBridge (monthly cron)
    # events:
    #   - schedule: cron(0 0 1 * ? *)  # 1st of every month at midnight

  getSecurityMetrics:
    handler: src/handlers/getSecurityMetrics.handler
    events:
      - http:
          path: security/metrics
          method: get
          cors: true


plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    noPrependStageInUrl: false
    printOutput: true

resources:
  Resources:
    UsedJtiTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USED_JTI_TABLE}
        AttributeDefinitions:
          - AttributeName: jti
            AttributeType: S
        KeySchema:
          - AttributeName: jti
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    AuditTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.AUDIT_TABLE}
        AttributeDefinitions:
          - AttributeName: auditId
            AttributeType: S
        KeySchema:
          - AttributeName: auditId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        StreamSpecification:
          StreamViewType: NEW_IMAGE

    SecurityQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-security-alerts

    SecurityTestInstance:
      Type: AWS::EC2::Instance
      Properties:
        InstanceType: t3.micro
        ImageId: ami-0694d931cee176e7d # Ubuntu 22.04 LTS (eu-west-1)
        Tags:
          - Key: Name
            Value: ${self:service}-${self:provider.stage}-test-instance